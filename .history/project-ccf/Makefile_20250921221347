# Credit Card Fraud Detection - Makefile
# Simplifie les commandes de dÃ©veloppement et dÃ©ploiement

.PHONY: help setup start stop clean test ingest transform load pipeline status logs

# Variables
DOCKER_COMPOSE = docker-compose -f docker/docker-compose.yml
PYTHON = python
VENV_ACTIVATE = venv/Scripts/activate  # Windows
# VENV_ACTIVATE = venv/bin/activate    # Linux/Mac

help: ## Affiche l'aide
	@echo "ğŸš€ Credit Card Fraud Detection - Commandes disponibles:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'

setup: ## Installation complÃ¨te du projet
	@echo "ğŸš€ Installation du projet..."
	$(PYTHON) setup.py

start: ## DÃ©marre tous les services Docker
	@echo "ğŸš€ DÃ©marrage des services..."
	$(DOCKER_COMPOSE) up -d
	@echo "âœ… Services dÃ©marrÃ©s!"
	@echo "ğŸ“‹ Interfaces disponibles:"
	@echo "  â€¢ Airflow: http://localhost:8080 (admin/admin)"
	@echo "  â€¢ PgAdmin: http://localhost:5050 (admin@ccf.local/admin123)"
	@echo "  â€¢ Jupyter: http://localhost:8888 (token: ccf_token)"

stop: ## ArrÃªte tous les services Docker
	@echo "â¹ï¸  ArrÃªt des services..."
	$(DOCKER_COMPOSE) down
	@echo "âœ… Services arrÃªtÃ©s!"

restart: stop start ## RedÃ©marre tous les services

status: ## Affiche le statut des services
	@echo "ğŸ“Š Statut des services:"
	$(DOCKER_COMPOSE) ps

logs: ## Affiche les logs de tous les services
	$(DOCKER_COMPOSE) logs -f

logs-airflow: ## Affiche les logs Airflow uniquement
	$(DOCKER_COMPOSE) logs -f airflow-webserver airflow-scheduler airflow-worker

build: ## Reconstruit les images Docker
	@echo "ğŸ”¨ Reconstruction des images..."
	$(DOCKER_COMPOSE) build --no-cache
	@echo "âœ… Images reconstruites!"

# Pipeline commands
ingest: ## Execute l'ingestion des donnÃ©es
	@echo "ğŸ“¥ DÃ©marrage de l'ingestion..."
	$(PYTHON) scripts/ingest.py
	@echo "âœ… Ingestion terminÃ©e!"

transform: ## Execute la transformation PySpark
	@echo "âš™ï¸  DÃ©marrage de la transformation..."
	$(PYTHON) scripts/transform_spark.py
	@echo "âœ… Transformation terminÃ©e!"

load: ## Execute le chargement PostgreSQL
	@echo "ğŸ“Š DÃ©marrage du chargement..."
	$(PYTHON) scripts/load_postgres.py
	@echo "âœ… Chargement terminÃ©!"

pipeline: ingest transform load ## Execute le pipeline complet
	@echo "ğŸ‰ Pipeline complet terminÃ©!"

# Development commands
test: ## Execute les tests unitaires
	@echo "ğŸ§ª ExÃ©cution des tests..."
	$(PYTHON) -m pytest tests/ -v
	@echo "âœ… Tests terminÃ©s!"

test-coverage: ## Execute les tests avec couverture
	@echo "ğŸ§ª Tests avec couverture..."
	$(PYTHON) -m pytest tests/ --cov=scripts --cov-report=html
	@echo "ğŸ“Š Rapport de couverture: htmlcov/index.html"

lint: ## VÃ©rifie la qualitÃ© du code
	@echo "ğŸ” VÃ©rification du code..."
	$(PYTHON) -m flake8 scripts/ tests/
	$(PYTHON) -m black --check scripts/ tests/
	@echo "âœ… Code vÃ©rifiÃ©!"

format: ## Formate le code
	@echo "ğŸ¨ Formatage du code..."
	$(PYTHON) -m black scripts/ tests/
	@echo "âœ… Code formatÃ©!"

# Data commands
download-data: ## TÃ©lÃ©charge uniquement les donnÃ©es Kaggle
	@echo "ğŸ“¥ TÃ©lÃ©chargement des donnÃ©es..."
	kaggle datasets download -d mlg-ulb/creditcardfraud -p data/raw --unzip
	@echo "âœ… DonnÃ©es tÃ©lÃ©chargÃ©es!"

clean-data: ## Nettoie les donnÃ©es temporaires
	@echo "ğŸ§¹ Nettoyage des donnÃ©es..."
	rm -rf data/processed/*
	rm -rf data/archive/*
	rm -rf logs/*
	@echo "âœ… DonnÃ©es nettoyÃ©es!"

# Database commands
db-connect: ## Se connecte Ã  PostgreSQL
	docker exec -it ccf_postgres psql -U ccf_user -d ccf_db

db-backup: ## Sauvegarde la base de donnÃ©es
	@echo "ğŸ’¾ Sauvegarde de la base de donnÃ©es..."
	docker exec ccf_postgres pg_dump -U ccf_user ccf_db > backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Sauvegarde crÃ©Ã©e!"

db-reset: ## Remet Ã  zÃ©ro la base de donnÃ©es
	@echo "ğŸ”„ Reset de la base de donnÃ©es..."
	docker exec ccf_postgres psql -U ccf_user -d ccf_db -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
	@echo "âœ… Base de donnÃ©es remise Ã  zÃ©ro!"

# Monitoring commands
monitor: ## Lance le monitoring des ressources
	@echo "ğŸ“Š Monitoring des ressources..."
	docker stats

airflow-trigger: ## DÃ©clenche manuellement le DAG Airflow
	@echo "ğŸš€ DÃ©clenchement du DAG..."
	docker exec ccf_airflow_webserver airflow dags trigger credit_card_fraud_pipeline
	@echo "âœ… DAG dÃ©clenchÃ©!"

# Cleanup commands
clean: ## Nettoie tous les fichiers temporaires
	@echo "ğŸ§¹ Nettoyage complet..."
	rm -rf __pycache__/
	rm -rf .pytest_cache/
	rm -rf htmlcov/
	rm -rf *.pyc
	rm -rf .coverage
	@echo "âœ… Nettoyage terminÃ©!"

clean-all: stop clean clean-data ## Nettoie tout et arrÃªte les services
	@echo "ğŸ§¹ Nettoyage complet avec arrÃªt des services..."
	docker system prune -f
	@echo "âœ… Nettoyage complet terminÃ©!"

# Environment commands
env-check: ## VÃ©rifie l'environnement
	@echo "ğŸ” VÃ©rification de l'environnement..."
	$(PYTHON) --version
	pip list | grep -E "(pyspark|pandas|sqlalchemy|airflow)"
	docker --version
	docker-compose --version
	@echo "âœ… Environnement vÃ©rifiÃ©!"

env-install: ## Installe les dÃ©pendances Python
	@echo "ğŸ“¦ Installation des dÃ©pendances..."
	pip install -r requirements.txt
	@echo "âœ… DÃ©pendances installÃ©es!"

# Documentation
docs: ## GÃ©nÃ¨re la documentation
	@echo "ğŸ“š GÃ©nÃ©ration de la documentation..."
	# Add documentation generation commands here
	@echo "âœ… Documentation gÃ©nÃ©rÃ©e!"

# Quick start
quick-start: start airflow-trigger ## DÃ©marrage rapide complet
	@echo "ğŸš€ DÃ©marrage rapide terminÃ©!"
	@echo "ğŸ“‹ VÃ©rifiez Airflow: http://localhost:8080"
